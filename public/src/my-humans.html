<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iris-polymer-table/iris-table.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="./components/service-selector/service-selector.html">
<link rel="import" href="./components/schedule-picker/schedule-picker.html">
<link rel="import" href="./components/permissions-picker/permissions-picker.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-humans">
		<template>
				<style include="shared-styles">
						:host {
								display: block;
								padding: 10px;
						}
						iris-table {
								max-height: calc(100vh - 155px);
						}
						.line {
								align-items: center;
						}
						paper-fab#delete {
								bottom: 10px;
						}
						.line paper-input {
								padding-right: 15px;
								flex: 1;
						}

				</style>

				<app-route route="{{route}}" pattern="/:itemId/:subpage" data="{{routeData}}"></app-route>

				<template is="dom-if" if="[[listVisible]]">
						<div class="line">
								<paper-input label="Поиск" value="{{searchString}}"></paper-input>
								<paper-dropdown-menu label="Права">
										<paper-listbox id="bookingMethods" class="dropdown-content" attr-for-selected="val" selected="{{permissionfilter}}">
												<paper-item val="*">Любые</paper-item>
												<paper-item val="ticket-by-id-registered">Прием</paper-item>
												<paper-item val="ticket-by-id-postponed">Прием из отложенных</paper-item>
												<paper-item val="can-admin">Администратор</paper-item>
												<paper-item val="can-report">Отчеты</paper-item>
												<paper-item val="can-book">Запись</paper-item>
												<paper-item val="can-manage">Ресепшен</paper-item>
										</paper-listbox>
								</paper-dropdown-menu>
						</div>
						<iris-table id="workstationsTable" fields-model="[[fieldsModel]]" data="[[filter(app.list,searchString,permissionfilter)]]" on-cell-tap="cellTap"></iris-table>
						<paper-fab id="add" mini icon="add" on-tap="addEntity"></paper-fab>
				</template>
				<template is="dom-if" if="[[!listVisible]]">
						<paper-tabs selected="{{routeData.subpage}}" attr-for-selected="page">
								<paper-tab on-tap="back" style="max-width:50px;">
										<iron-icon icon="chevron-left"></iron-icon>
								</paper-tab>
								<paper-tab page="common">Основные</paper-tab>
								<paper-tab page="provides">Услуги</paper-tab>
								<paper-tab page="workstations">Рабочие места</paper-tab>
								<paper-tab page="schedules">Расписания</paper-tab>
								<paper-tab page="permissions">Права</paper-tab>
						</paper-tabs>
						<iron-pages selected="{{routeData.subpage}}" attr-for-selected="page">
								<div page=""></div>
								<div page="common">
										<paper-input label="Фамилия" value="{{item.last_name}}" placeholder="Фамилия"></paper-input>
										<paper-input label="Имя" value="{{item.first_name}}" placeholder="Имя"></paper-input>
										<paper-input label="Отчество" value="{{item.middle_name}}" placeholder="Отчество"></paper-input>
										<paper-input label="Логин" value="{{item.login}}" placeholder="Логин"></paper-input>
										<paper-input label="Пароль" value="{{item.password_hash}}" placeholder="Пароль"></paper-input>
										<paper-dropdown-menu label="Тип приема">
												<paper-listbox class="dropdown-content" attr-for-selected="val" selected="{{item.filtering_method}}">
														<paper-item val="*">Все</paper-item>
														<paper-item val="live">Живая очередь</paper-item>
														<paper-item val="prebook">Предварительная запись</paper-item>
												</paper-listbox>
										</paper-dropdown-menu>
								</div>
								<div page="provides">
										<service-selector services="[[app.helpers.services]]" selected="{{item.provides}}"></service-selector>
								</div>
								<div page="workstations">
										<service-selector services="[[transformWS(app.helpers.workstations)]]" selected="{{item.available_workstation}}"></service-selector>
								</div>
								<div page="schedules">
										<h3>Ресурсное расписание</h3>
										<schedule-picker schedules="{{app.helpers.schedule}}" selected="{{item.has_schedule.resource}}"></schedule-picker>
										<h3>Живая очередь</h3>
										<schedule-picker schedules="{{app.helpers.schedule}}" selected="{{item.has_schedule.live}}" multi></schedule-picker>
										<h3>Предварительная запись</h3>
										<schedule-picker schedules="{{app.helpers.schedule}}" selected="{{item.has_schedule.prebook}}" multi></schedule-picker>
								</div>
								<div page="permissions">
										<permissions-picker departments="{{transformDep(app.helpers.offices)}}" value="{{item.permissions}}"></permissions-picker>
								</div>
						</iron-pages>
						<paper-fab id="save" mini icon="save" hidden$="[[!changed]]" on-tap="saveAll"></paper-fab>
						<paper-fab id="delete" mini icon="delete" on-tap="deleteDialog"></paper-fab>
				</template>

				<paper-dialog opened="{{isOpen}}" on-iron-overlay-closed="delete">
						<h2>Удаление</h2>
						<paper-dialog-scrollable>
								[[deleteMessage]]
						</paper-dialog-scrollable>
						<div class="buttons">
								<paper-button dialog-dismiss>Нет</paper-button>
								<paper-button dialog-confirm>Да</paper-button>
						</div>
				</paper-dialog>
				<paper-dialog opened="{{isOpenDiscard}}" on-iron-overlay-closed="discardChanges">
						<h2>Изменения будут потеряны</h2>
						<paper-dialog-scrollable>
								[[discardMessage]]
						</paper-dialog-scrollable>
						<div class="buttons">
								<paper-button dialog-dismiss>Нет</paper-button>
								<paper-button dialog-confirm>Да</paper-button>
						</div>
				</paper-dialog>
		</template>

		<script>
				Polymer({
						is: 'my-humans',
						behaviors: [ListBehavior],
						_correct() {
								this.item.has_schedule = this.item.has_schedule || {};
						},
						transformWS(ws) {
								return _.chain(ws).map(item => [item["@id"], item.label]).fromPairs().value();
						},
						transformDep(dep) {
								return _.chain(dep).filter({"@type": 'Department'}).map(item => ({id: item["@id"], label: item.label})).value();
						},
						randomString(number) {
								let text = "";
								const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

								for (var i = 0; i < number; i++)
										text += possible.charAt(Math.floor(Math.random() * possible.length));

								return text;
						},
						makeEntity() {

								return {
										"@type": "Employee",
										"@id": `human-${Date.now()}-${Math.ceil(Math.random() * 10000)}`,
										"first_name": "Имя",
										"last_name": "Фамилия",
										"middle_name": "Отчество",
										"login": this.randomString(15),
										"password_hash": this.randomString(6),
										"provides": [],
										"permissions": {
												"ticket-by-id": {
														"registered": false,
														"postponed": false
												}
										},
										"state": "inactive",
										"available_workstation": []
								};
						},
						hasPermission(item, filter) {
								if (filter === 'ticket-by-id-registered') {
										return _.get(item, ['permissions', 'ticket-by-id', 'registered']) || false;
								}
								if (filter === 'ticket-by-id-postponed') {
										return _.get(item, ['permissions', 'ticket-by-id', 'postponed']) || false;
								}
								const perm = _.get(item, ['permissions', filter]);
								return !!_.find(perm, item => !!item);
						},
						filter(data, searchString, filter) {
								let result = !searchString
										? data
										: _.filter(data, item => ~ (item.last_name || '').indexOf(searchString));

								result = (!filter || filter === '*')
										? result
										: _.filter(result, item => this.hasPermission(item, filter));
								return result;
						},
						commonPermision(data, label) {
								_.reduce(data, (acc, perm, dep) => {
										if (!perm)
												return acc;
										acc.push({value: dep, label: 'Администратор'})
										return acc;
								}, []);
						},
						permissionsToString(data, name) {
								const commonPermision = (data, label) => {
										return _.reduce(data, (acc, perm, value) => {
												if (!perm) {
														return acc;
												}
												acc.push({value, label})
												return acc;
										}, []);
								};
								switch (name) {
										case 'ticket-by-id':
												return [
														{
																label: 'Прием',
																value: data.registered
																		? '+'
																		: '-'
														}, {
																label: 'Прием из отложенных',
																value: data.postponed
																		? '+'
																		: '-'
														}
												];
										case 'can-report':
												return commonPermision(data, 'Отчеты');
										case 'can-manage':
												return commonPermision(data, 'Респшен');
										case 'can-book':
												return commonPermision(data, 'Запись');
										case 'can-admin':
												return commonPermision(data, 'Администратор');
										default:
												return '';
								}

						},
						ready: function () {
								this.deleteMessage = "Вы действительно хотите удалить этого сотрудника?";
								this.discardMessage = "	Вы действительно хотите отменить изменения?";
								this.entityName = 'humans';
								const transform = value => value || '-';
								this.permissionfilter = "*";
								this.fieldsModel = [
										{
												field: 'first_name',
												label: 'Имя',
												transform
										}, {
												field: 'last_name',
												label: 'Фамилия',
												transform
										}, {
												field: 'middle_name',
												label: 'Отчество',
												transform
										}, {
												field: 'login',
												label: 'Логин'
										}
								];
						}
				});
		</script>
</dom-module>
