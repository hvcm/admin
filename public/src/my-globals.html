<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<dom-module id="my-globals">
		<template>
				<style include="shared-styles">
						:host {
								display: block;
								padding: 10px;
						}
						iris-login {
								background-color: white;
								max-width: 480px;
								margin: 0 auto;
						}
						.toggle {
								display: flex;
								flex-direction: row;
						}
						.toggle label {
								padding-right: 25px;
						}
						paper-fab {
								position: fixed;
								right: 40px;
						}
						paper-fab#save {
								bottom: 60px;
						}
						paper-fab#add {
								bottom: 10px;
						}

				</style>
				<div id="globals">

						<template is="dom-repeat" items="[[app.list]]">
								<div class="field">
										<paper-input label="Ключ" value="{{item.key}}"></paper-input>
										<paper-input label="ID" value="{{item.__index}}"></paper-input>
										<paper-input label="Значение по умолчанию" value="{{item.default}}"></paper-input>
										<paper-input label="Описание" value="{{item.description}}"></paper-input>
										<paper-input label="Подпись" value="{{item.label}}"></paper-input>
										<paper-input label="Порядок" value="{{item.order}}"></paper-input>
										<paper-input label="Количество символов" value="{{item.length}}"></paper-input>
										<paper-input label="Максимальное значение" value="{{item.max-value}}"></paper-input>
										<div class="toggle">
												<label>Обязательное поле</label>
												<paper-toggle-button label="Обязательное поле" checked="{{item.required}}"></paper-toggle-button>
										</div>
										<div class="toggle">
												<label>Включено по умолчанию</label>
												<paper-toggle-button label="Включено" checked="{{item.include}}"></paper-toggle-button>
										</div>

										<paper-dropdown-menu label="Клавиатура">
												<paper-listbox class="dropdown-content" attr-for-selected="val" selected="{{item.layout}}">
														<template is="dom-repeat" items="[[layouts]]" as="keyboard">
																<paper-item val="[[keyboard.id]]">[[keyboard.label]]</paper-item>
														</template>
												</paper-listbox>
										</paper-dropdown-menu>

										<paper-dropdown-menu label="Метод регистрацияя">
												<paper-listbox class="dropdown-content" attr-for-selected="val" selected="{{item.method}}">
														<paper-item val="live">Живая очередь</paper-item>
														<paper-item val="prebook">Предварительная запись</paper-item>
												</paper-listbox>
										</paper-dropdown-menu>

										<paper-dropdown-menu label="Тип поля">
												<paper-listbox class="dropdown-content" attr-for-selected="val" selected="{{item.type}}">
														<template is="dom-repeat" items="[[types]]" as="type">
																<paper-item val="[[type.id]]">[[type.label]]</paper-item>
														</template>
												</paper-listbox>
										</paper-dropdown-menu>
										<paper-button raised on-tap="deleteDialog">Удалить</paper-button>
								</div>

						</template>
						<paper-fab id="save" mini icon="save" on-tap="saveAll"></paper-fab>
						<paper-fab id="add" mini icon="add" on-tap="addField"></paper-fab>
				</div>

				<paper-dialog opened="{{isOpen}}" on-iron-overlay-closed="delete">
						<h2>Удаление поля</h2>
						<paper-dialog-scrollable>
								Вы действительно хотите удалить это поле
						</paper-dialog-scrollable>
						<div class="buttons">
								<paper-button dialog-dismiss>Нет</paper-button>
								<paper-button dialog-confirm>Да</paper-button>
						</div>
				</paper-dialog>
		</template>

		<script>
				const defaultField = {
						default: '',
						description: "Введите описание",
						include: true,
						key: "random-key-",
						label: "Введите подпись",
						layout: "ru-layout",
						length: 100,
						"max-value": '',
						method: "live",
						order: 0,
						required: true,
						type: "input",
						__index: "random-key-"
				};
				Polymer({
						is: 'my-globals',
						properties: {
								app: {
										type: Object
								},
								types: {
										type: Array,
										value: [
												{
														id: 'input',
														label: 'Текстовое поле'
												}, {
														id: 'date-picker',
														label: 'Выбор даты'
												}, {
														id: 'input-number',
														label: 'Цифровое поле'
												}
										]
								},
								layouts: {
										type: Array,
										value: [
												{
														id: "email",
														label: "e-mail"
												}, {
														id: "en-layout",
														label: "Английская"
												}, {
														id: "numeric",
														label: "Цифровая"
												}, {
														id: "ru-layout",
														label: "Русская"
												}, {
														id: "ru-letnum",
														label: "Русская цифры и буквы"
												}, {
														id: "ru-letters",
														label: "Русская буквы"
												}
										]
								}
						},
						addField() {
								const field = _.clone(defaultField);
								const rnd = Math.ceil(Math.random() * 100000);
								field.key = field.key + rnd;
								field.__index = field.__index + rnd;
								this.push('app.list', field);
								this.debounce('xx', () => {
										const last = _.last(this.$.globals.querySelectorAll('.field'));
										last.scrollIntoView();
								}, 300);
						},
						saveAll() {
								window.api.saveEntity('fields', _.chain(this.app.list).keyBy('__index').value())
						},
						deleteDialog(e) {
								this.toDelete = e.model.index;
								this.isOpen = true;
						},
						delete(e) {
								if (!e.detail.confirmed)
										return;
								this.splice('app.list', this.toDelete, 1);
						}
				});
		</script>
</dom-module>
